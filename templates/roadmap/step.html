{% extends "base.html" %}

{% block title %}{{ roadmap.title }} - Step {{ current_step.step_number }} - BuyHigh.io{% endblock %}

{% block content %}
<div class="space-y-8">
  <!-- Back navigation -->
  <div class="mb-8">
    <a href="{{ url_for('roadmap.roadmap') }}" class="inline-flex items-center text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-neo-purple dark:hover:text-neo-purple transition-colors">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to Roadmap
    </a>
  </div>
  
  <!-- Header -->
  <div class="mb-10">
    <div class="flex items-center mb-3">
      <div class="bg-neo-purple text-white text-xs font-pixel px-2 py-1 rounded-lg shadow-neo mr-3">Step {{ current_step.step_number }}</div>
      <h1 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-neo-purple to-neo-blue">{{ current_step.title }}</h1>
    </div>
    <p class="text-gray-600 dark:text-gray-300 max-w-3xl">
      {{ current_step.description }}
    </p>
  </div>

  <!-- Step Content Sections -->
  <div class="glass-card rounded-2xl overflow-hidden border border-gray-200/10 dark:border-gray-700/20 p-6">
    <div class="prose prose-lg dark:prose-invert max-w-none">
      <!-- Dynamically load card HTML content -->
      {% for item in page_layout %}
      <div class="card-section">
        {{ item.card_html | safe }}
      </div>
      {% endfor %}
    </div>
  </div>
  
  <!-- Navigation -->
  <div class="flex justify-between mt-10">
    {% if current_step.step_number > 1 %}
    <a href="{{ url_for('roadmap.roadmap_step', roadmap_id=roadmap.id, step_id=current_step.step_number - 1) }}" 
       class="neo-button px-4 py-2 rounded-lg text-sm font-medium bg-neo-purple/10 text-neo-purple border border-neo-purple/20 hover:bg-neo-purple hover:text-white flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Previous Step
    </a>
    {% else %}
    <div></div>
    {% endif %}
    
    {% set next_step_number = current_step.step_number + 1 %}
    {% set max_step_number = roadmap_steps|map(attribute='step_number')|max %}
    
    {% if next_step_number <= max_step_number %}
    <a href="{{ url_for('roadmap.roadmap_step', roadmap_id=roadmap.id, step_id=next_step_number) }}" 
       class="neo-button px-4 py-2 rounded-lg text-sm font-medium bg-neo-blue/10 text-neo-blue border border-neo-blue/20 hover:bg-neo-blue hover:text-white flex items-center">
      Next Step
      <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </a>
    {% else %}
    <a href="{{ url_for('roadmap.roadmap') }}"
       class="neo-button px-4 py-2 rounded-lg text-sm font-medium bg-neo-emerald/10 text-neo-emerald border border-neo-emerald/20 hover:bg-neo-emerald hover:text-white flex items-center">
        Finish Roadmap
        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
    </a>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle quiz form submissions
    const quizForms = document.querySelectorAll('.quiz-form');
    quizForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // If correct answer
            if (data.correct) {
              // Find the selected button and mark it as correct
              const selectedButton = form.querySelector(`button[value="${formData.get('quiz_answer')}"]`);
              selectedButton.classList.add('neo-button-emerald');
              
              // Display success message
              const successMessage = document.createElement('div');
              successMessage.className = 'mt-3 p-3 glass-card border border-neo-emerald/30 bg-neo-emerald/5 text-neo-emerald text-center font-medium rounded-lg';
              successMessage.textContent = 'Correct! +25 XP gained.';
              form.parentNode.appendChild(successMessage);
            } else {
              // Find the selected button and mark it as incorrect
              const selectedButton = form.querySelector(`button[value="${formData.get('quiz_answer')}"]`);
              selectedButton.classList.add('neo-button-red');
              
              // Display error message
              const errorMessage = document.createElement('div');
              errorMessage.className = 'mt-3 p-3 glass-card border border-neo-red/30 bg-neo-red/5 text-neo-red text-center font-medium rounded-lg';
              errorMessage.textContent = 'Incorrect. Try again!';
              form.parentNode.appendChild(errorMessage);
            }
          } else {
            // Display generic error
            alert(data.message || 'An error occurred. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred. Please try again.');
        });
      });
    });

    // Temporary function to handle quiz answers until backend is ready
    window.handleQuizAnswer = function(button) {
      // Simulate response
      const isCorrect = Math.random() > 0.5; // 50% chance of being correct
      
      if (isCorrect) {
        // Show correct answer UI
        button.classList.add('neo-button-emerald');
        
        // Display success message
        const form = button.closest('form');
        const successMessage = document.createElement('div');
        successMessage.className = 'mt-3 p-3 glass-card border border-neo-emerald/30 bg-neo-emerald/5 text-neo-emerald text-center font-medium rounded-lg';
        successMessage.textContent = 'Correct! +25 XP gained.';
        form.parentNode.appendChild(successMessage);
      } else {
        // Show incorrect answer UI
        button.classList.add('neo-button-red');
        
        // Display error message
        const form = button.closest('form');
        const errorMessage = document.createElement('div');
        errorMessage.className = 'mt-3 p-3 glass-card border border-neo-red/30 bg-neo-red/5 text-neo-red text-center font-medium rounded-lg';
        errorMessage.textContent = 'Incorrect. Try again!';
        form.parentNode.appendChild(errorMessage);
      }
      
      // Disable all buttons in this form
      const buttons = button.closest('form').querySelectorAll('button');
      buttons.forEach(b => {
        b.disabled = true;
        if (b !== button) {
          b.classList.add('opacity-50');
        }
      });
    };
  });
</script>

<!-- Add CSS styles for the quiz buttons from dashboard.html -->
<style>
  /* Quiz Button Styles */
  .quiz-btn {
    @apply font-medium border transition-all duration-200;
    padding: 1.1rem 2.2rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    min-width: 220px;
    text-align: left;
    border-radius: 1rem;
    background: rgba(255, 255, 255, 0.07);
    color: #1e293b;
    border: 1.5px solid rgba(139, 92, 246, 0.2);
    box-shadow: 0 2px 8px 0 rgba(139, 92, 246, 0.05);
    position: relative;
    overflow: hidden;
  }

  .dark .quiz-btn {
    background: rgba(31, 41, 55, 0.4);
    color: #e5e7eb;
    border-color: rgba(139, 92, 246, 0.3);
  }

  .quiz-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
    transition: 0.5s;
  }

  .quiz-btn:hover::before {
    left: 100%;
  }

  .quiz-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px 0 rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.5);
    background: rgba(139, 92, 246, 0.08);
  }

  .dark .quiz-btn:hover:not(:disabled) {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.6);
  }

  .quiz-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .quiz-btn.neo-button-emerald {
    background: rgba(16, 185, 129, 0.15) !important;
    border-color: #10b981 !important;
    color: #065f46 !important;
  }

  .dark .quiz-btn.neo-button-emerald {
    background: rgba(16, 185, 129, 0.2) !important;
    border-color: #10b981 !important;
    color: #a7f3d0 !important;
  }

  .quiz-btn.neo-button-red {
    background: rgba(239, 68, 68, 0.15) !important;
    border-color: #ef4444 !important;
    color: #991b1b !important;
  }

  .dark .quiz-btn.neo-button-red {
    background: rgba(239, 68, 68, 0.2) !important;
    border-color: #ef4444 !important;
    color: #fca5a5 !important;
  }
</style>
{% endblock %}
